<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>Loading</title>

    <link href="/css/bootstrap.min.css" rel="stylesheet">
    <link rel="icon" type="image/x-icon" href="/favicon.ico">

    <link href="/default.css" rel="stylesheet">

    <style>
        .floatBlock {
            position: absolute;
            opacity: 0.5;
            background-color: #f4f4f4;
            z-index: -1;
        }
    </style>
</head>

<body>
    <nav id="menu" class="navbar navbar-inverse navbar-fixed-top">
        <div class="container">
            <div class="navbar-header">
                <a class="navbar-brand" href="/gallery">SunSite</a>
            </div>

            <div class="collapse navbar-collapse">
                <ul class="nav navbar-nav">
                    <li><a href="/gallery">Gallery</a></li>
                    <li><a href="/illustrator">Illustrator</a></li>
                    <li><a href="/group">Group</a></li>
                    <li class="active"><a href="/collection">Collection</a></li>
                    <li><a href="/type">Type</a></li>
                </ul>
            </div>
        </div>
    </nav>

    <div id="content" class="container">
        <div id="floatBlock" class="floatBlock" style="display:none"></div>

        <div id="header" class="row">
            <div id="collection" class="col-sm-12 col-md-12 col-lg-12">
            </div>
            <div id="group" class="col-sm-12 col-md-12 col-lg-12">
            </div>
        </div>

        <div id="pictureList" class="row">
        </div>
    </div>

    <div id="page">
        <ul class="pager">
            <li id="pageItem" class="disabled"><a id="pageLink">1</a></li>
        </ul>
    </div>

    <nav id="tool" class="navbar navbar-inverse" style="margin-bottom: 0;">
        <div class="container">
            <div class="collapse navbar-collapse">
                <ul class="nav navbar-nav">
                    <li><button class="toolBarButton" id="modify" type="button" data-toggle="modal" data-target="#modifyCollection">Modify</button></li>
                    <li><button class="toolBarButton" id="download" type="button">Download</button></li>
                    <li><button class="toolBarButton" id="delete" type="button">Delete</button></li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="modal fade" id="modifyCollection" tabindex="-1" role="dialog">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <!--<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>-->
                    <h4 class="modal-title">Modify</h4>
                </div>
                <div class="modal-body">
                    <label for="modifyName">Name</label>
                    <input type="text" name="name" id="modifyName" autocomplete="off">
                </div>
                <div class="modal-footer">
                    <data-togglebutton type="button" class="btn btn-default" data-dismiss="modal">Close</data-togglebutton>
                    <button type="button" id="save" class="btn btn-primary">Save</button>
                </div>
            </div>
        </div>
    </div>

    <script src="/jquery-2.0.3.min.js"></script>
    <script src="/js/bootstrap.min.js"></script>

    <script>
        window.onload = function () {
            getCollectionInfo();

            getPictureList(0);
        };

        function getCollectionInfo() {
            var r = window.location.href.split("/");
            var sequence = r[r.length-1];

            $.get("/collection/info?seq=" + sequence, function (data) {
                document.title = data.collection + " | Collection";

                var collection = document.getElementById("collection");
                var c = document.createElement("h3");
                c.innerText = data.collection;
                collection.appendChild(c);

                var group = document.getElementById("group");
                var g = document.createElement("h5");
                var link = document.createElement("a");
                link.setAttribute("id", "groupInfo"); // 为了上传时能获取到
                link.setAttribute("href", "/group/show/" + encodeURIComponent(data.group));
                link.innerText = data.group;
                g.appendChild(link);
                group.appendChild(g);

                $('#modifyName').val(data.collection);
            });
        }

        function getPictureList(page) {
            var r = window.location.href.split("/");
            var sequence = r[r.length-1];

            $.get("/collection/detail?seq=" + sequence + "&p=" + page, function (data) {
                pictureListHandler(data, page);
            });
        }

        function pictureListHandler(data, page) {
            if (data.code === 0) {
                for (i = 0; i < data.pictureList.length; ++i) {
                    // var sequence = data.fileList[i];
                    setPicture(data.pictureList[i]);
                }

                page = page - 0 + 1;
                if (page >= data.pageCount) {   // 如果页数到顶了，就要删除页码
                    if (page > 1) { // page=1时就是初始化的时候，已经默认创建好了
                        let pageButton = document.getElementById("pageItem");
                        pageButton.setAttribute("class", "disabled");

                        let pageLink = document.getElementById("pageLink");
                        pageLink.innerText = page;
                    }
                } else if (page === 1) { // page=1即初始化，这时候创建页码
                    let pageButton = document.getElementById("pageItem");
                    pageButton.setAttribute("class", "");
                } else {    // 正常情况page+1，更新
                    let pageLink = document.getElementById("pageLink");
                    pageLink.innerText = page;
                }
            } else if (data.code === 4) {
                let pageButton = document.getElementById("pageItem");
                pageButton.setAttribute("class", "disabled");

                alert(data.msg);
            } else
                window.location.href = "/error";
        }

        // function setPicture(data) {
        //     var pictureList = document.getElementById("pictureList");
        //
        //     var sequence = data.sequence;
        //     var name = data.name;
        //
        //     var imageElement = document.createElement("div");
        //     imageElement.setAttribute("class", "col-sm-4 col-md-3 col-lg-2");
        //     imageElement.setAttribute("id", sequence);
        //     pictureList.appendChild(imageElement);
        //
        //     var contentDiv = document.createElement("div");
        //     contentDiv.setAttribute("class", "thumbnail");
        //
        //     var imageLink = document.createElement("a");
        //     imageLink.setAttribute("href", "/gallery/show/" + sequence);
        //     imageLink.setAttribute("target", "_blank");
        //
        //     var image = document.createElement("img");
        //     image.src = "/m/" + sequence;
        //     image.title = name;
        //
        //     imageLink.appendChild(image);
        //     contentDiv.appendChild(imageLink);
        //
        //     var infoDiv = document.createElement("div");
        //     infoDiv.setAttribute("class", "caption");
        //
        //     var nameElement = document.createElement("p");
        //     nameElement.innerText = name;
        //     nameElement.setAttribute("style", "display: block; overflow:hidden; white-space:nowrap;");
        //
        //     contentDiv.appendChild(nameElement);
        //     imageElement.appendChild(contentDiv);
        //
        //     let h = imageElement.offsetWidth;
        //     imageLink.setAttribute("style", "height: " + h + "px;");
        //     h += nameElement.offsetHeight;
        //     imageElement.setAttribute("style", "height: " + h + "px;");
        //     contentDiv.setAttribute("style", "height: " + h + "px;");
        // }

        function setPicture(data) {
            var pictureList = document.getElementById("pictureList");

            var sequence = data.sequence;
            var name = data.name;

            var imageElement = document.createElement("div");
            imageElement.setAttribute("class", "col-sm-4 col-md-3 col-lg-2");
            imageElement.setAttribute("id", sequence);
            pictureList.appendChild(imageElement);

            var image = document.createElement("img");
            image.src = "/m/" + sequence;
            image.title = name;

            var imageLink = document.createElement("a");
            imageLink.setAttribute("href", "/gallery/show/" + sequence);
            imageLink.setAttribute("target", "_blank");
            imageLink.setAttribute("class", "thumbnail");

            imageLink.appendChild(image);
            imageElement.appendChild(imageLink);

            let h = imageElement.offsetWidth;
            imageElement.setAttribute("style", "height: " + h + "px;");
            imageLink.setAttribute("style", "height: " + h + "px;");
        }

        $(function () {
            $("#pageLink").click(function () {
                var page = document.getElementById("pageLink");
                getPictureList(page.innerText);
            });
        });
    </script>

    <script>
        var uploadArea = document.getElementById("content");
	    uploadArea.addEventListener("dragenter", function (e) {
			e.preventDefault();
		    // e.stopPropagation();
            // uploadEvent();
    	});
        uploadArea.addEventListener("dragleave", function (e) {
		    e.preventDefault();
		    // e.stopPropagation();
            overEvent();
    	});
		uploadArea.addEventListener("dragover", function (e) {
	    	e.preventDefault();
			// e.stopPropagation();
            uploadEvent(false);
	    });
	    uploadArea.addEventListener("drop", function (e) {
			e.preventDefault();
		    // e.stopPropagation();
            uploadEvent(true);
            uploadFile(this.files || e.dataTransfer.files);
        });

        // 上传
        function uploadEvent(setZIndex) {
            var floatBlock = document.getElementById("floatBlock");

            var content = document.getElementById("content");
            // var pictureList = document.getElementById("pictureList");
            // var height = header.offsetHeight + pictureList.offsetHeight;

            floatBlock.style.width = content.offsetWidth + "px";
            floatBlock.style.height = content.offsetHeight + "px";
            floatBlock.style.display = "block";
            if (setZIndex)
                floatBlock.style.zIndex = 256;
        }

        function overEvent() {
            var floatBlock = document.getElementById("floatBlock");
            floatBlock.style.display = "none";
            floatBlock.style.zIndex = -1;
        }

        function uploadFile(fileList) {
            var formData = new FormData();
            for (i = 0; i < fileList.length; ++i) {
                formData.append("file", fileList[i]);
            }

            $.ajax({
                method: 'post',
                url: "/gallery/upload",
                data: formData,
                cache: false,   //上传文件无需缓存
                processData: false, //用于对data参数进行序列化处理 这里必须false
                contentType: false //必须
            }).done(function (data) {
                // overEvent();
                if (data.code === 0) {
                    var group = document.getElementById("groupInfo").innerText;
                    uploadInfo(prompt("Illustrator : ", group), data.uploadCode);
                } else {
                    alert(data.msg);
                    window.location.reload();
                }
            }).fail(function () {
                alert("error");
                window.location.href = "./error";
            });
        }

        function uploadInfo(illustrator, uploadCode) {
            if (illustrator == null) {
                overEvent();
                return;
            }

            var collection = document.getElementById("collection").innerText;
            var group = document.getElementById("groupInfo").innerText;

            var data = {
                "illustrator": illustrator,
                "group" : group,
                "collection": collection,
                "uploadCode": uploadCode
            };

            $.ajax({
                method: 'post',
                url: "/gallery/uploadInfo",
                data: JSON.stringify(data),
                dataType: "JSON",
                contentType: "application/json"
            }).done(function (data) {
                alert(data.msg);
                window.location.reload();
            }).fail(function () {
                alert("error");
                window.location.href = "/error";
            });
        }
    </script>

    <script>
        $(function () {
            $("#download").click(function () {
                var r = window.location.href.split("/");
                var sequence = r[r.length-1];

                window.location.href = "/collection/download/" + sequence;
            });
        });

        $(function () {
            $("#delete").click(function () {
                var button = this;
                $(button).attr('disabled', 'disabled');

                var r = window.location.href.split("/");
                var sequence = r[r.length-1];

                var data = {
                    "deleteInfo": sequence
                };

                $.ajax({
                    method: 'post',
                    url: "/collection/delete",
                    data: JSON.stringify(data),
                    dataType: "JSON",
                    contentType: "application/json"
                }).done(function (data) {
                    alert(data.msg);
                    window.location.href = "/collection";
                }).fail(function () {
                    alert("error");
                    window.location.href = "/error";
                });
            });
        });

        $(function () {
            $("#save").click(function () {
                var button = this;
                $(button).attr('disabled', 'disabled');

                var r = window.location.href.split("/");
                var sequence = r[r.length-1];

                var newName = $('#modifyName').val();

                var data = {
                    "sequence": sequence,
                    "newName": newName
                };

                $.ajax({
                    method: 'post',
                    url: "/collection/modify",
                    data: JSON.stringify(data),
                    dataType: "JSON",
                    contentType: "application/json"
                }).done(function (data) {
                    alert(data.msg);
                    if (data.newLinkInfo)
                        window.location.href = "/collection/show/" + data.newLinkInfo;
                    else
                        window.location.reload();
                }).fail(function () {
                    alert("error");
                    window.location.href = "/error";
                });
            });
        });
    </script>
</body>
</html>