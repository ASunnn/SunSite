<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Loading...</title>
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <script src="https://ajax.aspnetcdn.com/ajax/jQuery/jquery-1.9.0.min.js"></script>
    <style>
        /* 标题菜单 */
        .menu {
            margin-left: auto;
            margin-right: auto;
            width: 1800px;
            height: 70px;
            margin-top: 15px;
            margin-bottom: 15px;
        }
        .menuContent {
            text-align: center;
            float: left;
            width: 200px;
            height: 70px;
        }
        .menuLink {
            position: relative;
            top: 40px;
        }
        ul, li {
            list-style-type:none;
            padding: 0;
            margin: 0;
        }
        /* 图片列表 */
        .info {
            margin: 10px;
        }
        .pictureList {
            display: inline-block;
            text-align: center;
            width: 280px;
            height: 295px;
            margin: 10px;
            background-color: dimgrey;
        }
        .imageDiv {
            width: 250px; 
            height: 250px; 
            margin: auto; 
        }
        img {
            display: block;
            margin: auto;
        }
        .next {
            text-align: center;
            margin: 30px;
        }
        .floatBlock {
            position: absolute;
            opacity: 0.5;
            background-color: #f4f4f4;
            z-index: -1;
        }
        /* 工具 */
        .toolContent {
            text-align: center;
            float: left;
            width: 200px;
            height: 40px;
        }
        .separator {
            float: left;
            width: 2px;
        }
        /* 修改表单 */ 
        .modifyContent {
            margin:auto;
            margin-top:20px;
            margin-bottom:20px;
            width:1800px;
            text-align:center;
            /* background-color: #fafafa; */
        }
        .modifyInput {
            width: 200px;
            height: 20px;
        }
        label {
            display: inline-block;
            width: 100px;
            height: 30px;
            margin: auto;
            text-align: right;
        }
        input {
            background-color: lightgrey;
        }
        /* 通用 */
        a {
            text-decoration: none;
            color: lightgrey;
        }
    </style>

    <script>
        window.onload = function () {
            getCollectionInfo();
            
            getPictureList(0);
        };
    </script>

    <script>
        function getCollectionInfo() {
            var r = window.location.href.split("/");
            var sequence = r[r.length-1];

            $.get("/collection/info?seq=" + sequence, function (data) {
                document.title = data.collection + " | Collection";

                var theme = document.getElementById("theme");
                theme.innerText = data.collection;

                var header = document.getElementById("header");
                var g = document.createElement("p");
                g.setAttribute("id", "group");
                g.setAttribute("class", "info");
                var link = document.createElement("a");
                link.setAttribute("href", "/group/show/" + encodeURIComponent(data.group));
                link.innerText = data.group;
                g.appendChild(link);
                header.appendChild(g);

                $('#modifyName').val(data.collection);
            });
        }

        function getPictureList(page) {
            var r = window.location.href.split("/");
            var sequence = r[r.length-1];

            $.get("/collection/detail?seq=" + sequence + "&p=" + page, function (data) {
                pictureListHandler(data, page);
            });

            var pictureList = document.getElementById("pictureList");
        }

        function pictureListHandler(data, page) {
            if (data.code == 0) {
                for (i = 0; i < data.pictureList.length; ++i) {
                    // var sequence = data.fileList[i];
                    setPicture(data.pictureList[i]);
                }

                page = page - 0 + 1;
                if (page >= data.pageCount) {   // 如果页数到顶了，就要删除页码
                    if (page > 1) { // page=1时就是初始化的时候，创都没创建
                        var nextButton = document.getElementById("next");
                        nextButton.remove();
                    }
                } else if (page == 1) { // page=1即初始化，这时候创建页码
                    var nextButton = document.createElement("h3");
                    nextButton.setAttribute("id", "next");
                    nextButton.setAttribute("class", "next");
                    nextButton.innerText = page;

                    var pageElement = document.getElementById("page");
                    pageElement.appendChild(nextButton);
                } else {    // 正常情况page+1，更新
                    var nextButton = document.getElementById("next");
                    nextButton.innerText = page;
                }
            } else if (data.code == 4) {
                var nextButton = document.getElementById("next");
                if (nextButton)
                    nextButton.remove();
                alert(data.msg);
            } else
                window.location.href = "/error";
        }

        function setPicture(data) {
            var pictureList = document.getElementById("pictureList");

            var sequence = data.sequence;
            var name = data.name;

            var divElement = document.createElement("div");
            divElement.setAttribute("class", "pictureList");
            divElement.setAttribute("id", sequence);
            pictureList.appendChild(divElement);

            var imageDiv = document.createElement("div");
            imageDiv.setAttribute("class", "imageDiv");

            var image = document.createElement("img");
            image.src = "/m/" + sequence;

            var imageLink = document.createElement("a");
            imageLink.setAttribute("href", "/gallery/show/" + sequence);
            imageLink.setAttribute("target", "_blank");
            imageLink.appendChild(image);
            imageDiv.appendChild(imageLink);

            divElement.appendChild(imageDiv);

            var nameElement = document.createElement("p");
            nameElement.innerText = name;
            nameElement.setAttribute("style", "display: block; overflow:hidden; white-space:nowrap;");
            divElement.appendChild(nameElement);
        }

        $(function () {
            $("#page").click(function () {
                var page = document.getElementById("next");
                getPictureList(page.innerText);
            });
        });
    </script>
    <!-- 下载、删除 -->
    <script>
        $(function () {
            $("#modify").click(function () {
                var modifyContent = document.getElementById("modifyContent");
                if (modifyContent.style.display == "none")
                    modifyContent.style.display = "block";
                else
                    modifyContent.style.display = "none";
            });
        });

        $(function () {
            $("#download").click(function () {
                var r = window.location.href.split("/");
                var sequence = r[r.length-1];

                window.location.href = "/collection/download/" + sequence;
            });
        });

        $(function () {
            $("#delete").click(function () {
                var r = window.location.href.split("/");
                var sequence = r[r.length-1];

                var data = {
                    "deleteInfo": sequence
                };
    
                $.ajax({
                    method: 'post',
                    url: "/collection/delete",
                    data: JSON.stringify(data),
                    dataType: "JSON",
                    contentType: "application/json"
                }).done(function (data) {
                    alert(data.msg);
                    window.location.href = "/collection";
                }).fail(function () {
                    alert("error");
                    window.location.href = "/error";
                });
            });
        });

        $(function () {
            $("#submit").click(function () {
                var button = this;
                $(button).attr('disabled', 'disabled');
                
                var r = window.location.href.split("/");
                var sequence = r[r.length-1];

                var newName = $('#modifyName').val();

                var data = {
                    "sequence": sequence,
                    "newName": newName
                }

                $.ajax({
                    method: 'post',
                    url: "/collection/modify",
                    data: JSON.stringify(data),
                    dataType: "JSON",
                    contentType: "application/json"
                }).done(function (data) {
                    alert(data.msg);
                    window.location.reload();
                }).fail(function () {
                    alert("error");
                    window.location.href = "/error";
                });
            });
        });
    </script>
    <!-- 上传 -->
    <script>
        function uploadEvent(setZIndex) {
            var floatBlock = document.getElementById("floatBlock");
            
            var pictureList = document.getElementById("pictureList");
            var count = pictureList.childElementCount - 1;
            var height = Math.ceil(count / 6) * 315;
            
            floatBlock.style.width = "1800px";
            floatBlock.style.height = height + "px";
            floatBlock.style.display = "block";
            if (setZIndex)
                floatBlock.style.zIndex = 256;
        }

        function overEvent() {
            var floatBlock = document.getElementById("floatBlock");
            floatBlock.style.display = "none";
            floatBlock.style.zIndex = -1;
        }

        function uploadFile(fileList) {
            var formData = new FormData();
            for (i = 0; i < fileList.length; ++i) {
                formData.append("file", fileList[i]);
            }
            
            $.ajax({
                method: 'post',
                url: "/gallery/upload",
                data: formData,
                cache: false,   //上传文件无需缓存
                processData: false, //用于对data参数进行序列化处理 这里必须false
                contentType: false //必须
            }).done(function (data) {
                alert(data.msg);
                // overEvent();
                if (data.code == 0) {
                    var group = document.getElementById("group").childNodes[0].innerText;
                    uploadInfo(prompt("Illustrator : ", group), data.uploadCode);
                } else {
                    window.location.reload();
                }
            }).fail(function () {
                alert("error");
                window.location.href = "./error";
            });
        }

        function uploadInfo(illustrator, uploadCode) {
            if (illustrator == null) {
                overEvent();
                return;
            }
            
            var group = document.getElementById("group").childNodes[0].innerText;
            var collection = document.getElementById("theme").innerText;

            var data = {
                "illustrator": illustrator,
                "group" : group,
                "collection": collection,
                "uploadCode": uploadCode
            };

            $.ajax({
                method: 'post',
                url: "/gallery/uploadInfo",
                    data: JSON.stringify(data),
                dataType: "JSON",
                contentType: "application/json"
            }).done(function (data) {
                alert(data.msg);
                window.location.reload();
            }).fail(function () {
                alert("error");
                    window.location.href = "/error";
            });
        }
    </script>
</head>

<body style="background-color:#333333; color:lightgrey">
    <div class="menu">
        <ul>
            <li class="menuContent" style="text-align:center; font-size:50px">
                SunSite
            </li>
            <li class="menuContent">
                <a class="menuLink" href="/gallery">Gallery</a>
            </li>
            <li class="menuContent">
                <a class="menuLink" href="/illustrator">Illustrator</a>
            </li>
            <li class="menuContent">
                <a class="menuLink" href="/group">Group</a>
            </li>
            <li class="menuContent">
                <a class="menuLink" href="/collection">Collection</a>
            </li>
            <li class="menuContent">
                <a class="menuLink" href="/type">Type</a>
            </li>
        </ul>
    </div>
    <hr style="border-color:black" />
    <div id="content" style="margin:auto; width:1800px;">
        <div id="header">
            <p id="theme" class="info" style="font-weight:bold; font-size:larger;"></p>
        </div>
        <div id="pictureList">
            <div id="floatBlock" class="floatBlock" style="display:none"></div>
        </div>
        <div id="page">
        </div>
        <div id="tool">
            <ul style="width:604px; height:40px; margin:auto;">
                <li id="modify" class="toolContent">
                    Modify
                </li>
                <li class="separator">|</li>
                <li id="download" class="toolContent">
                    Download
                </li>
                <li class="separator">|</li>
                <li id="delete" class="toolContent">
                    Delete
                </li>
            </ul>
        </div>
    </div>
    <hr style="border-color:black" />
    <div id="modifyContent" class="modifyContent" style="display: none">
        <form id="modifyInfoForm">
            <label for="name">Name</label>
            <input type="text" name="name" id="modifyName" class="modifyInput", autocomplete="off"/>
            <br />
            <input id="submit" type="button" value="sumbit!">
        </form>
    </div>
    <script>
        var uploadArea = document.getElementById("pictureList")
	    uploadArea.addEventListener("dragenter", function (e) {
			e.preventDefault();
		    // e.stopPropagation();
            // uploadEvent();
    	})
        uploadArea.addEventListener("dragleave", function (e) {
		    e.preventDefault();
		    // e.stopPropagation();
            overEvent();
    	})
		uploadArea.addEventListener("dragover", function (e) {
	    	e.preventDefault();
			// e.stopPropagation();
            uploadEvent(false);
	    })
	    uploadArea.addEventListener("drop", function (e) {
			e.preventDefault();
		    // e.stopPropagation();
            uploadEvent(true);
            uploadFile(this.files || e.dataTransfer.files);
        })
    </script>
</body>
</html>